// SPDX-License-Identifier: MIT
pragma solidity ^0.8.10;

contract Proxy {
    event Deploy(address);

    fallback() external payable {}

    receive() external payable { }
    //传入Helper.getBytecode1() 获取 TestContract1 的创建字节码生成新的 TestContract1 合约, 返回新合约地址4
    /*
    TestContract1 字节码
    0x000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000003206080604052335f5f6101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550348015604d575f5ffd5b506102c58061005b5f395ff3fe608060405234801561000f575f5ffd5b5060043610610034575f3560e01c806313af4035146100385780638da5cb5b14610054575b5f5ffd5b610052600480360381019061004d91906101c4565b610072565b005b61005c610142565b60405161006991906101fe565b60405180910390f35b5f5f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614610100576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016100f790610271565b60405180910390fd5b805f5f6101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555050565b5f5f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b5f5ffd5b5f73ffffffffffffffffffffffffffffffffffffffff82169050919050565b5f6101938261016a565b9050919050565b6101a381610189565b81146101ad575f5ffd5b50565b5f813590506101be8161019a565b92915050565b5f602082840312156101d9576101d8610166565b5b5f6101e6848285016101b0565b91505092915050565b6101f881610189565b82525050565b5f6020820190506102115f8301846101ef565b92915050565b5f82825260208201905092915050565b7f6e6f74206f776e657200000000000000000000000000000000000000000000005f82015250565b5f61025b600983610217565b915061026682610227565b602082019050919050565b5f6020820190508181035f8301526102888161024f565b905091905056fea2646970667358221220a9c4c7b5e6b02a01dbbeb8754751e410ed7fb2f02ecb7ecf866baab11c7e2b0864736f6c634300081e0033
    */
    // TestContract1 新地址 0x051DF98f93A618662255fa9BD11A55ec1BbDA0DA

    /*
    TestContract2 字节码
    0x6080604052335f5f6101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550346001556040516102ba3803806102ba833981810160405281019061006891906100b4565b816002819055508060038190555050506100f2565b5f5ffd5b5f819050919050565b61009381610081565b811461009d575f5ffd5b50565b5f815190506100ae8161008a565b92915050565b5f5f604083850312156100ca576100c961007d565b5b5f6100d7858286016100a0565b92505060206100e8858286016100a0565b9150509250929050565b6101bb806100ff5f395ff3fe608060405234801561000f575f5ffd5b506004361061004a575f3560e01c80630c55699c1461004e5780633fa4f2451461006c5780638da5cb5b1461008a578063a56dfe4a146100a8575b5f5ffd5b6100566100c6565b6040516100639190610114565b60405180910390f35b6100746100cc565b6040516100819190610114565b60405180910390f35b6100926100d2565b60405161009f919061016c565b60405180910390f35b6100b06100f6565b6040516100bd9190610114565b60405180910390f35b60025481565b60015481565b5f5f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b60035481565b5f819050919050565b61010e816100fc565b82525050565b5f6020820190506101275f830184610105565b92915050565b5f73ffffffffffffffffffffffffffffffffffffffff82169050919050565b5f6101568261012d565b9050919050565b6101668161014c565b82525050565b5f60208201905061017f5f83018461015d565b9291505056fea2646970667358221220bc112bed894a3445b28f572b16f913ecc9d0925b0c85c7ddc383e6043fc2b17264736f6c634300081e0033000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000014
    */
    // TestContract2 新地址 0x5a6f82d055C80dA06cda79D035DbA679987a85c8
    function deploy(bytes memory _code) external payable returns (address addr) {
        assembly {
            // create(v, p, n)
            // v = amount of ETH to send
            // p = pointer in memory to start of code
            // n = size of code
            addr := create(callvalue(), add(_code, 0x20), mload(_code))
        }
        // return address 0 on error
        require(addr != address(0), "deploy failed");

        emit Deploy(addr);
    }
    /*
    
    TestContract1 新地址 0x051DF98f93A618662255fa9BD11A55ec1BbDA0DA
    TestContract1 setOwner(address) 的函数选择器 0x13af4035
    0x051DF98f93A618662255fa9BD11A55ec1BbDA0DA,0x13af4035
    */
    function execute(address _target, bytes memory _data) external payable {
        (bool success, ) = _target.call{value: msg.value}(_data);
        require(success, "failed");
    }
    //函数选择器
    // "setOwner(address)" 0x13af4035
    function getSelector(string calldata _func) external pure returns (bytes4) {
        return bytes4(keccak256(bytes(_func)));
    }
}

contract TestContract1 {
    address public owner = msg.sender;

    function setOwner(address _owner) public {
        require(msg.sender == owner, "not owner");
        owner = _owner;
    }
}

contract TestContract2 {
    address public owner = msg.sender;
    uint public value = msg.value;
    uint public x;
    uint public y;

    constructor(uint _x, uint _y) payable {
        x = _x;
        y = _y;
    }
}

contract Helper {
    //获取 TestContract1 的创建字节码
    /*
    
    0x000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000003206080604052335f5f6101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550348015604d575f5ffd5b506102c58061005b5f395ff3fe608060405234801561000f575f5ffd5b5060043610610034575f3560e01c806313af4035146100385780638da5cb5b14610054575b5f5ffd5b610052600480360381019061004d91906101c4565b610072565b005b61005c610142565b60405161006991906101fe565b60405180910390f35b5f5f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614610100576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016100f790610271565b60405180910390fd5b805f5f6101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555050565b5f5f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b5f5ffd5b5f73ffffffffffffffffffffffffffffffffffffffff82169050919050565b5f6101938261016a565b9050919050565b6101a381610189565b81146101ad575f5ffd5b50565b5f813590506101be8161019a565b92915050565b5f602082840312156101d9576101d8610166565b5b5f6101e6848285016101b0565b91505092915050565b6101f881610189565b82525050565b5f6020820190506102115f8301846101ef565b92915050565b5f82825260208201905092915050565b7f6e6f74206f776e657200000000000000000000000000000000000000000000005f82015250565b5f61025b600983610217565b915061026682610227565b602082019050919050565b5f6020820190508181035f8301526102888161024f565b905091905056fea2646970667358221220a9c4c7b5e6b02a01dbbeb8754751e410ed7fb2f02ecb7ecf866baab11c7e2b0864736f6c634300081e0033
    
    */
    function getBytecode1() external pure returns (bytes memory) {
        bytes memory bytecode = type(TestContract1).creationCode;
        return bytecode;
    }

    /*
    0x6080604052335f5f6101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550346001556040516102ba3803806102ba833981810160405281019061006891906100b4565b816002819055508060038190555050506100f2565b5f5ffd5b5f819050919050565b61009381610081565b811461009d575f5ffd5b50565b5f815190506100ae8161008a565b92915050565b5f5f604083850312156100ca576100c961007d565b5b5f6100d7858286016100a0565b92505060206100e8858286016100a0565b9150509250929050565b6101bb806100ff5f395ff3fe608060405234801561000f575f5ffd5b506004361061004a575f3560e01c80630c55699c1461004e5780633fa4f2451461006c5780638da5cb5b1461008a578063a56dfe4a146100a8575b5f5ffd5b6100566100c6565b6040516100639190610114565b60405180910390f35b6100746100cc565b6040516100819190610114565b60405180910390f35b6100926100d2565b60405161009f919061016c565b60405180910390f35b6100b06100f6565b6040516100bd9190610114565b60405180910390f35b60025481565b60015481565b5f5f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b60035481565b5f819050919050565b61010e816100fc565b82525050565b5f6020820190506101275f830184610105565b92915050565b5f73ffffffffffffffffffffffffffffffffffffffff82169050919050565b5f6101568261012d565b9050919050565b6101668161014c565b82525050565b5f60208201905061017f5f83018461015d565b9291505056fea2646970667358221220bc112bed894a3445b28f572b16f913ecc9d0925b0c85c7ddc383e6043fc2b17264736f6c634300081e0033000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000014
    */
    function getBytecode2(uint _x, uint _y) external pure returns (bytes memory) {
        bytes memory bytecode = type(TestContract2).creationCode;
        return abi.encodePacked(bytecode, abi.encode(_x, _y));
    }
    //  0x13af40350000000000000000000000005b38da6a701c568545dcfcb03fcb875f56beddc4
    function getCalldata(address _owner) external pure returns (bytes memory) {
        return abi.encodeWithSignature("setOwner(address)", _owner);
    }
}
